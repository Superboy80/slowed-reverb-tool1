<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slowed + Reverb Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-8 col-sm-12">
                <h1 class="text-center mb-4">ðŸŽµ Slowed + Reverb Magic Tool</h1>
                <p class="text-center text-muted">Upload your song, apply slowed + reverb effect, and download the vibe!</p>
                
                <div class="card shadow-lg">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="audioFile" class="form-label">Upload Audio File (MP3/WAV, max 100MB)</label>
                            <input type="file" class="form-control" id="audioFile" accept="audio/*">
                        </div>
                        
                        <div class="mb-3">
                            <label for="slowSpeed" class="form-label">Slow Speed (0.5x to 1x)</label>
                            <input type="range" class="form-range" id="slowSpeed" min="0.5" max="1" step="0.1" value="0.8">
                            <span id="speedValue">0.8x</span>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reverbTime" class="form-label">Reverb Time (seconds)</label>
                            <input type="range" class="form-range" id="reverbTime" min="1" max="5" step="0.5" value="2">
                            <span id="reverbValue">2s</span>
                        </div>
                        
                        <button class="btn btn-primary w-100 mb-3" id="processBtn" disabled>Apply Effect & Download</button>
                        
                        <div id="progress" class="progress mb-3" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;">Processing...</div>
                        </div>
                        
                        <audio id="preview" controls class="w-100 mb-3" style="display: none;"></audio>
                        
                        <a id="downloadLink" class="btn btn-success w-100" style="display: none;">Download Processed Audio</a>
                        
                        <div id="errorMsg" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Cool purple gradient background */
    min-height: 100vh;
    font-family: 'Arial', sans-serif;
    color: #333;
}

h1 {
    color: white;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    font-weight: bold;
}

.card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    backdrop-filter: blur(10px); /* Glassmorphism effect for modern look */
}

.btn {
    border-radius: 25px;
    font-weight: bold;
}

.progress {
    height: 25px;
    border-radius: 15px;
}

#preview {
    border-radius: 10px;
}

/* Mobile Optimization */
@media (max-width: 768px) {
    h1 {
        font-size: 1.8rem;
    }
    .card-body {
        padding: 1rem;
    }
    input[type="range"] {
        width: 100%;
    }
}

/* Desktop Smoothness */
@media (min-width: 769px) {
    .card {
        max-width: 600px;
        margin: 0 auto;
    }
}
document.addEventListener('DOMContentLoaded', function() {
    const audioFileInput = document.getElementById('audioFile');
    const processBtn = document.getElementById('processBtn');
    const progress = document.getElementById('progress');
    const progressBar = progress.querySelector('.progress-bar');
    const preview = document.getElementById('preview');
    const downloadLink = document.getElementById('downloadLink');
    const errorMsg = document.getElementById('errorMsg');
    const slowSpeed = document.getElementById('slowSpeed');
    const reverbTime = document.getElementById('reverbTime');
    const speedValue = document.getElementById('speedValue');
    const reverbValue = document.getElementById('reverbValue');

    // Update sliders display
    slowSpeed.addEventListener('input', () => speedValue.textContent = slowSpeed.value + 'x');
    reverbTime.addEventListener('input', () => reverbValue.textContent = reverbTime.value + 's');

    // File upload
    audioFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.size > 100 * 1024 * 1024) {
            showError('File too large! Max 100MB.');
            return;
        }
        if (file) {
            processBtn.disabled = false;
            preview.src = URL.createObjectURL(file); // Preview original
            preview.style.display = 'block';
        }
    });

    // Process button
    processBtn.addEventListener('click', async function() {
        const file = audioFileInput.files[0];
        if (!file) {
            showError('Please upload a file first!');
            return;
        }

        showProgress(0);
        try {
            const audioBuffer = await loadAudio(file);
            const processedBuffer = await applyEffects(audioBuffer, parseFloat(slowSpeed.value), parseFloat(reverbTime.value));
            const processedBlob = await bufferToWave(processedBuffer, file.sampleRate || 44100);
            const url = URL.createObjectURL(processedBlob);
            
            downloadLink.href = url;
            downloadLink.download = `slowed-reverb_${file.name}`;
            downloadLink.style.display = 'block';
            preview.src = url; // Preview processed
            hideError();
        } catch (err) {
            showError('Error processing audio: ' + err.message);
        }
        hideProgress();
    });

    // Helper functions
    async function loadAudio(file) {
        const arrayBuffer = await file.arrayBuffer();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        showProgress(25);
        return await audioContext.decodeAudioData(arrayBuffer);
    }

    async function applyEffects(buffer, speed, reverbTime) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createBufferSource();
        source.buffer = buffer;

        // Slowed effect (change playback rate)
        const slowedBuffer = audioContext.createBuffer(buffer.numberOfChannels, buffer.length / speed, buffer.sampleRate * speed);
        for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
            const inputData = buffer.getChannelData(channel);
            const outputData = slowedBuffer.getChannelData(channel);
            for (let i = 0; i < slowedBuffer.length; i++) {
                outputData[i] = inputData[Math.floor(i * speed)] || 0;
            }
        }
        source.buffer = slowedBuffer;

        // Reverb effect (simple convolver)
        const reverb = audioContext.createConvolver();
        const reverbBuffer = audioContext.createBuffer(1, audioContext.sampleRate * reverbTime, audioContext.sampleRate);
        const reverbData = reverbBuffer.getChannelData(0);
        // Simple impulse response for reverb (you can make it more complex)
        for (let i = 0; i < reverbData.length; i++) {
            reverbData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / reverbData.length, 2);
        }
        reverb.buffer = reverbBuffer;

        const gain = audioContext.createGain();
        gain.gain.value = 0.7; // Mix to avoid clipping

        source.connect(reverb);
        reverb.connect(gain);
        gain.connect(audioContext.destination);

        // Render to offline buffer for download
        const offlineContext = new OfflineAudioContext(buffer.numberOfChannels, slowedBuffer.length, slowedBuffer.sampleRate);
        const offlineSource = offlineContext.createBufferSource();
        offlineSource.buffer = slowedBuffer;
        offlineSource.connect(reverb);
        reverb.buffer = reverbBuffer; // Reuse
        reverb.connect(offlineContext.destination);
        showProgress(50);
        return await offlineSource.start(0);
        showProgress(75);
        return await offlineContext.startRendering();
    }

    function bufferToWave(buffer, sampleRate) {
        const numChannels = buffer.numberOfChannels;
        const length = buffer.length * numChannels * 2 + 44;
        const arrayBuffer = new ArrayBuffer(length);
        const view = new DataView(arrayBuffer);
        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };
        writeString(0, 'RIFF');
        view.setUint32(4, 36 + buffer.length * numChannels * 2, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * numChannels * 2, true);
        view.setUint16(32, numChannels * 2, true);
        view.setUint16(34, 16, true);
        writeString(36, 'data');
        view.setUint32(40, buffer.length * numChannels * 2, true);

        // Write samples
        let offset = 44;
        for (let i = 0; i < buffer.length; i++) {
            for (let channel = 0; channel < numChannels; channel++) {
                const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
        }
        showProgress(100);
        return new Blob([arrayBuffer], { type: 'audio/wav' });
    }

    function showProgress(percent) {
        progress.style.display = 'block';
        progressBar.style.width = percent + '%';
        progressBar.textContent = 'Processing... ' + percent + '%';
    }

    function hideProgress() {
        progress.style.display = 'none';
    }

    function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = 'block';
        processBtn.disabled = true;
    }

    function hideError() {
        errorMsg.style.display = 'none';
    }
});
