<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Slowed + Reverb Tool</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      background: #121212; 
      color: white; 
      padding: 20px;
    }
    input[type=range] {
      width: 300px;
    }
    .control {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üé∂ Slowed + Reverb Tool</h1>
  <input type="file" id="fileInput" accept="audio/*"><br><br>
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="stopBtn">‚èπ Stop</button>

  <div class="control">
    <label>Speed: <span id="speedVal">1.0</span>x</label><br>
    <input type="range" id="speedControl" min="0.5" max="1.5" value="1" step="0.01">
  </div>

  <div class="control">
    <label>Reverb: <span id="reverbVal">0.0</span></label><br>
    <input type="range" id="reverbControl" min="0" max="1" value="0" step="0.01">
  </div>

  <div class="control">
    <label>Echo: <span id="echoVal">0.0</span></label><br>
    <input type="range" id="echoControl" min="0" max="0.8" value="0" step="0.01">
  </div>

  <script>
    let audioCtx, source, reverbNode, delayNode, gainNode;
    let audioBuffer;

    const fileInput = document.getElementById('fileInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const speedControl = document.getElementById('speedControl');
    const reverbControl = document.getElementById('reverbControl');
    const echoControl = document.getElementById('echoControl');

    const speedVal = document.getElementById('speedVal');
    const reverbVal = document.getElementById('reverbVal');
    const echoVal = document.getElementById('echoVal');

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;
      const arrayBuffer = await file.arrayBuffer();
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    });

    function createAudioGraph() {
      source = audioCtx.createBufferSource();
      source.buffer = audioBuffer;
      source.playbackRate.value = parseFloat(speedControl.value);

      reverbNode = audioCtx.createConvolver();
      // Simple reverb impulse response
      const irBuffer = audioCtx.createBuffer(2, audioCtx.sampleRate * 3, audioCtx.sampleRate);
      for (let c = 0; c < irBuffer.numberOfChannels; c++) {
        let channelData = irBuffer.getChannelData(c);
        for (let i = 0; i < channelData.length; i++) {
          channelData[i] = (Math.random() * 2 - 1) * (1 - i / channelData.length);
        }
      }
      reverbNode.buffer = irBuffer;

      delayNode = audioCtx.createDelay();
      delayNode.delayTime.value = parseFloat(echoControl.value);

      gainNode = audioCtx.createGain();
      gainNode.gain.value = 1.0;

      // Chain: Source ‚Üí Reverb ‚Üí Echo ‚Üí Gain ‚Üí Destination
      source.connect(reverbNode);
      reverbNode.connect(delayNode);
      delayNode.connect(gainNode);
      gainNode.connect(audioCtx.destination);
    }

    playBtn.addEventListener('click', () => {
      if (!audioBuffer) return alert("Upload an audio first!");
      if (audioCtx.state === 'suspended') audioCtx.resume();
      createAudioGraph();
      source.start();
    });

    stopBtn.addEventListener('click', () => {
      if (source) source.stop();
    });

    // Live Controls
    speedControl.addEventListener('input', () => {
      speedVal.textContent = speedControl.value;
      if (source) source.playbackRate.value = parseFloat(speedControl.value);
    });

    reverbControl.addEventListener('input', () => {
      reverbVal.textContent = reverbControl.value;
      // Reverb intensity handled by gainNode
      if (gainNode) gainNode.gain.value = 1 + parseFloat(reverbControl.value);
    });

    echoControl.addEventListener('input', () => {
      echoVal.textContent = echoControl.value;
      if (delayNode) delayNode.delayTime.value = parseFloat(echoControl.value);
    });
  </script>
</body>
</html>
