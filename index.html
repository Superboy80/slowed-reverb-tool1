<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Slowed + Reverb Tool</title>
<style>
  :root{--bg:#0b1220;--card:#0f1724;--accent:#0bb0ff;--muted:#9aa7b2}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef6}
  .wrap{max-width:980px;margin:20px auto;padding:16px}
  .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.45)}
  h1{margin:0 0 6px;color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0;flex-wrap:wrap}
  label{min-width:120px;color:#cfe8ff}
  input[type="range"]{width:260px}
  select,input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #223;background:#08121a;color:#dff}
  button.primary{background:var(--accent);color:#032}
  audio{width:100%;margin-top:12px;border-radius:8px;background:#000}
  .small{font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:760px){ .grid{grid-template-columns:1fr} input[type="range"]{width:180px} label{min-width:90px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Live Slowed + Reverb Tool</h1>
    <div class="muted">Upload → Play → change effects live. (Preview only — no server upload.)</div>

    <div class="row">
      <label for="file">Select audio</label>
      <input id="file" type="file" accept="audio/*">
      <div style="margin-left:auto" class="small">Max recommended: 10 MB for mobile.</div>
    </div>

    <div class="row">
      <label for="preset">Preset</label>
      <select id="preset">
        <option value="custom">Custom</option>
        <option value="lofi">LoFi (slow + warm)</option>
        <option value="hall">Hall (big reverb)</option>
        <option value="club">Club (delay + bass)</option>
        <option value="clean">Clean (minimal)</option>
      </select>
      <button id="applyPreset" class="primary">Apply</button>
    </div>

    <div class="grid">
      <div>
        <div class="row"><label>Speed</label><input id="speed" type="range" min="0.5" max="1.2" step="0.01" value="0.85"><div id="speedText">0.85×</div></div>
        <div class="row"><label>Pitch (playback)</label><input id="pitch" type="range" min="0.5" max="1.5" step="0.01" value="1"><div id="pitchText">1.00</div></div>
        <div class="row"><label>Reverb</label><input id="reverb" type="range" min="0" max="1" step="0.01" value="0.5"><div id="reverbText">50%</div></div>
        <div class="row"><label>Decay (s)</label><input id="decay" type="range" min="0.2" max="6" step="0.1" value="2.4"><div id="decayText">2.4s</div></div>
      </div>

      <div>
        <div class="row"><label>Delay (s)</label><input id="delayTime" type="range" min="0" max="1.2" step="0.01" value="0.28"><div id="delayTimeText">0.28s</div></div>
        <div class="row"><label>Delay Feedback</label><input id="delayFB" type="range" min="0" max="0.95" step="0.01" value="0.42"><div id="delayFBText">42%</div></div>
        <div class="row"><label>Bass (dB)</label><input id="bass" type="range" min="-12" max="12" step="0.5" value="0"><div id="bassText">0 dB</div></div>
        <div class="row"><label>Treble (dB)</label><input id="treble" type="range" min="-12" max="12" step="0.5" value="0"><div id="trebleText">0 dB</div></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="playBtn" class="primary">Play</button>
      <button id="pauseBtn">Pause</button>
      <button id="stopBtn">Stop</button>
      <div style="flex:1"></div>
      <div id="status" class="small">Idle</div>
    </div>

    <audio id="audioEl" controls></audio>

    <div style="margin-top:10px" class="small">Tip: Use headphones. For long files, use desktop or smaller segments.</div>
  </div>
</div>

<script>
/* Real-time WebAudio preview tool
   - Uses HTMLAudioElement + MediaElementSource for live effects
   - PlaybackRate changed on audio element for "slowed" effect (affects duration)
   - Convolver (programmatic impulse) used for reverb (wet/dry mix)
   - Delay node for echo
   - Biquad nodes for bass/treble
   - Presets provided
*/

(() => {
  // UI refs
  const fileEl = document.getElementById('file');
  const presetEl = document.getElementById('preset');
  const applyPresetBtn = document.getElementById('applyPreset');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const audioEl = document.getElementById('audioEl');
  const statusEl = document.getElementById('status');

  // controls
  const speed = document.getElementById('speed');
  const speedText = document.getElementById('speedText');
  const pitch = document.getElementById('pitch');
  const pitchText = document.getElementById('pitchText');
  const reverb = document.getElementById('reverb');
  const reverbText = document.getElementById('reverbText');
  const decay = document.getElementById('decay');
  const decayText = document.getElementById('decayText');
  const delayTime = document.getElementById('delayTime');
  const delayTimeText = document.getElementById('delayTimeText');
  const delayFB = document.getElementById('delayFB');
  const delayFBText = document.getElementById('delayFBText');
  const bass = document.getElementById('bass');
  const bassText = document.getElementById('bassText');
  const treble = document.getElementById('treble');
  const trebleText = document.getElementById('trebleText');

  // UI show values
  const binds = [
    [speed, speedText, v=>v+'×'],
    [pitch, pitchText, v=>v],
    [reverb, reverbText, v=>Math.round(v*100)+'%'],
    [decay, decayText, v=>v+'s'],
    [delayTime, delayTimeText, v=>v+'s'],
    [delayFB, delayFBText, v=>Math.round(v*100)+'%'],
    [bass, bassText, v=>v+' dB'],
    [treble, trebleText, v=>v+' dB']
  ];
  binds.forEach(([el,txt,fmt])=>{
    el.addEventListener('input',()=> txt.innerText = fmt(el.value));
    txt.innerText = fmt(el.value);
  });

  // Presets
  const PRESETS = {
    lofi: {speed:0.85,pitch:1,reverb:0.5,decay:2.2,delayTime:0.18,delayFB:0.35,bass:2,treble:-1},
    hall: {speed:1,pitch:1,reverb:0.8,decay:3.8,delayTime:0.28,delayFB:0.45,bass:0,treble:1},
    club: {speed:1.02,pitch:1.02,reverb:0.35,decay:1.6,delayTime:0.12,delayFB:0.6,bass:5,treble:2},
    clean: {speed:1,pitch:1,reverb:0.12,decay:0.8,delayTime:0.0,delayFB:0,bass:0,treble:0}
  };

  applyPresetBtn.addEventListener('click', ()=>{
    const p = presetEl.value;
    if (PRESETS[p]) {
      const c = PRESETS[p];
      speed.value = c.speed; speedText.innerText = c.speed+'×';
      pitch.value = c.pitch; pitchText.innerText = c.pitch;
      reverb.value = c.reverb; reverbText.innerText = Math.round(c.reverb*100)+'%';
      decay.value = c.decay; decayText.innerText = c.decay+'s';
      delayTime.value = c.delayTime; delayTimeText.innerText = c.delayTime+'s';
      delayFB.value = c.delayFB; delayFBText.innerText = Math.round(c.delayFB*100)+'%';
      bass.value = c.bass; bassText.innerText = c.bass+' dB';
      treble.value = c.treble; trebleText.innerText = c.treble+' dB';
      statusEl.innerText = 'Preset applied: '+p;
      applyLiveParams(); // apply immediately if playing
    } else {
      statusEl.innerText = 'Custom mode';
    }
  });

  // AudioContext + nodes (created on first user gesture)
  let audioCtx = null;
  let srcNode = null;
  let dryGain, wetGain, convolverNode, delayNode, delayFeedbackGain, bassFilter, trebleFilter, masterGain;

  function ensureAudioContext() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // create nodes
    dryGain = audioCtx.createGain(); wetGain = audioCtx.createGain();
    convolverNode = audioCtx.createConvolver();
    delayNode = audioCtx.createDelay(5.0);
    delayFeedbackGain = audioCtx.createGain();
    bassFilter = audioCtx.createBiquadFilter(); bassFilter.type = 'lowshelf'; bassFilter.frequency.value = 200;
    trebleFilter = audioCtx.createBiquadFilter(); trebleFilter.type = 'highshelf'; trebleFilter.frequency.value = 3000;
    masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;

    // feedback loop
    delayNode.connect(delayFeedbackGain);
    delayFeedbackGain.connect(delayNode);

    // default connects will be established every time we create srcNode (see connectSource)
  }

  function connectSource() {
    // disconnect previous if exists
    try { if (srcNode) srcNode.disconnect(); } catch(e){}
    srcNode = audioCtx.createMediaElementSource(audioEl);

    // route: src -> bass -> treble -> (dry->master) and -> convolver->wet->master and -> delay->master
    srcNode.connect(bassFilter);
    bassFilter.connect(trebleFilter);

    // dry
    trebleFilter.connect(dryGain);
    dryGain.connect(masterGain);

    // reverb path
    trebleFilter.connect(convolverNode);
    convolverNode.connect(wetGain);
    wetGain.connect(masterGain);

    // delay path
    trebleFilter.connect(delayNode);
    delayNode.connect(masterGain);

    // master to destination
    masterGain.connect(audioCtx.destination);
  }

  // Create programmatic impulse response for convolver
  function createImpulseResponse(durationSec, decay) {
    const sr = audioCtx.sampleRate;
    const len = Math.floor(sr * durationSec);
    const ir = audioCtx.createBuffer(2, len, sr);
    for (let ch=0; ch<2; ch++){
      const data = ir.getChannelData(ch);
      for (let i=0;i<len;i++){
        // white noise with exponential decay
        data[i] = (Math.random()*2 -1) * Math.pow(1 - i/len, decay);
      }
    }
    return ir;
  }

  // Apply UI values to nodes (live)
  function applyLiveParams() {
    if (!audioCtx) return;
    // speed/pitch: playbackRate on audio element (affects duration)
    audioEl.playbackRate = parseFloat(speed.value) * parseFloat(pitch.value);
    // wet/dry
    wetGain.gain.value = parseFloat(reverb.value);
    dryGain.gain.value = 1 - parseFloat(reverb.value);
    // decay: regen impulse
    try {
      convolverNode.buffer = createImpulseResponse(parseFloat(decay.value), parseFloat(decay.value));
    } catch(e) { console.warn('Convolver IR error', e); }
    // delay
    delayNode.delayTime.value = parseFloat(delayTime.value);
    delayFeedbackGain.gain.value = parseFloat(delayFB.value);
    // EQ
    bassFilter.gain.value = parseFloat(bass.value);
    trebleFilter.gain.value = parseFloat(treble.value);
    // master gain left at 1.0
  }

  // file handling
  fileEl.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    // optional size check: warn if large
    if (f.size > 25 * 1024 * 1024) {
      if (!confirm('File is large and may be slow on mobile. Continue?')) { fileEl.value = ''; return; }
    }
    const url = URL.createObjectURL(f);
    audioEl.src = url;
    audioEl.load();
    statusEl.innerText = 'File loaded. Click Play.';
  });

  // Play / Pause / Stop handlers
  playBtn.addEventListener('click', async ()=> {
    if (!audioEl.src) return alert('Select a file first');
    // resume/create audio context on user gesture
    ensureAudioContext();
    // connect media source if not connected
    if (!srcNode) connectSource();
    applyLiveParams();
    try {
      // On some browsers AudioContext suspended until resumed by user gesture
      if (audioCtx.state === 'suspended') await audioCtx.resume();
    } catch(e){}
    await audioEl.play().catch(e=>{ console.warn(e); statusEl.innerText = 'Playback blocked. Tap to allow.'; });
    statusEl.innerText = 'Playing (live effects)';
  });

  pauseBtn.addEventListener('click', ()=> {
    audioEl.pause();
    statusEl.innerText = 'Paused';
  });

  stopBtn.addEventListener('click', ()=> {
    audioEl.pause();
    audioEl.currentTime = 0;
    statusEl.innerText = 'Stopped';
  });

  // update params live when sliders change
  [...document.querySelectorAll('input[type="range"]')].forEach(el=>{
    el.addEventListener('input', ()=>{
      applyLiveParams();
    });
  });

  // handle unload/cleanup
  window.addEventListener('beforeunload', ()=>{
    try { if (audioEl.src) URL.revokeObjectURL(audioEl.src); } catch(e){}
    try { if (audioCtx) audioCtx.close(); } catch(e){}
  });

  // initial text
  statusEl.innerText = 'Idle — load a file and press Play.';
})();
</script>
</body>
</html>
