<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Slowed + Reverb — Web Tool</title>
<style>
  :root{--accent:#0b76ef;--bg:#f6f8fb;--card:#fff}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:30px auto;padding:18px}
  .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
  h1{margin:0 0 8px;font-size:20px}
  .muted{color:#666;font-size:13px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
  label{min-width:110px;color:#333}
  input[type="range"]{width:240px}
  button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:rgba(11,118,239,0.9)}
  audio{width:100%;margin-top:14px}
  .status{margin-top:12px;color:var(--accent)}
  .download{display:inline-block;margin-top:10px;padding:8px 12px;background:#1aab4f;color:#fff;border-radius:8px;text-decoration:none}
  .small{font-size:13px;color:#555}
  footer{margin-top:16px;font-size:13px;color:#666}
  @media (max-width:560px){ input[type="range"]{width:160px} label{min-width:90px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Slowed + Reverb — Offline WAV Export</h1>
    <div class="muted small">Upload an audio file (mp3/wav). This runs in your browser only — no upload to server.</div>

    <div class="row" style="margin-top:16px">
      <label for="file">Select audio</label>
      <input id="file" type="file" accept="audio/*">
    </div>

    <div class="row">
      <label for="speed">Playback speed</label>
      <input id="speed" type="range" min="0.4" max="1.2" step="0.01" value="0.75">
      <div id="speedVal">0.75×</div>
    </div>

    <div class="row">
      <label for="reverb">Reverb amount</label>
      <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.35">
      <div id="reverbVal">35%</div>
    </div>

    <div class="row">
      <label for="decay">Reverb decay</label>
      <input id="decay" type="range" min="0.3" max="6" step="0.1" value="2.5">
      <div id="decayVal">2.5s</div>
    </div>

    <div class="row">
      <button id="previewBtn" class="primary">Preview</button>
      <button id="renderBtn">Render & Prepare Download</button>
      <button id="stopBtn">Stop</button>
      <div style="flex:1"></div>
      <div class="small">Tip: use desktop for large files.</div>
    </div>

    <div id="status" class="status"></div>

    <audio id="player" controls style="display:none"></audio>
    <a id="download" class="download" style="display:none">Download WAV</a>

    <footer>
      Built for Blogger embed (use iframe). If something fails, open browser console (F12) and share the error.
    </footer>
  </div>
</div>

<script>
(function(){
  const fileEl = document.getElementById('file');
  const speedEl = document.getElementById('speed');
  const reverbEl = document.getElementById('reverb');
  const decayEl = document.getElementById('decay');
  const previewBtn = document.getElementById('previewBtn');
  const renderBtn = document.getElementById('renderBtn');
  const stopBtn = document.getElementById('stopBtn');
  const status = document.getElementById('status');
  const player = document.getElementById('player');
  const downloadA = document.getElementById('download');
  const speedVal = document.getElementById('speedVal');
  const reverbVal = document.getElementById('reverbVal');
  const decayVal = document.getElementById('decayVal');

  let originalBuffer = null;
  let realtimeCtx = null;
  let liveSource = null;
  let lastURL = null;

  function setStatus(t){ status.innerText = t; }

  speedEl.addEventListener('input', ()=> speedVal.innerText = speedEl.value + '×');
  reverbEl.addEventListener('input', ()=> reverbVal.innerText = Math.round(reverbEl.value*100)+'%');
  decayEl.addEventListener('input', ()=> decayVal.innerText = decayEl.value + 's');

  fileEl.addEventListener('change', async (e)=>{
    originalBuffer = null;
    cleanupLast();
    const f = e.target.files && e.target.files[0];
    if(!f){ setStatus('No file selected'); return; }
    setStatus('Reading file...');
    try{
      const array = await f.arrayBuffer();
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      originalBuffer = await ac.decodeAudioData(array.slice(0));
      ac.close && ac.close();
      setStatus(`Loaded: ${f.name} — ${Math.round(originalBuffer.duration)}s, ${originalBuffer.numberOfChannels}ch`);
    }catch(err){
      console.error(err);
      setStatus('Error decoding file: '+(err.message||err));
    }
  });

  function createImpulse(context, duration, decay){
    const sr = context.sampleRate;
    const len = Math.floor(sr * duration);
    const impulse = context.createBuffer(2, len, sr);
    for(let ch=0; ch<impulse.numberOfChannels; ch++){
      const data = impulse.getChannelData(ch);
      for(let i=0;i<len;i++){
        const n = Math.random()*2 - 1;
        data[i] = n * Math.pow(1 - i/len, decay);
      }
    }
    return impulse;
  }

  async function renderBuffer(buffer, opts){
    const playbackRate = opts.playbackRate || 1;
    const reverbAmount = Math.max(0, Math.min(1, opts.reverbAmount||0));
    const decay = Math.max(0.1, opts.decay||2.5);
    const newDuration = buffer.duration / playbackRate;
    const sr = buffer.sampleRate;
    const channels = buffer.numberOfChannels;
    const offline = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(channels, Math.ceil(newDuration * sr) + 1, sr);
    const src = offline.createBufferSource();
    src.buffer = buffer;
    src.playbackRate.value = playbackRate;
    const dry = offline.createGain(); dry.gain.value = 1 - reverbAmount;
    const wet = offline.createGain(); wet.gain.value = reverbAmount;
    const conv = offline.createConvolver();
    conv.buffer = createImpulse(offline, Math.min(6, Math.max(0.2, decay)), decay);
    src.connect(dry).connect(offline.destination);
    src.connect(conv).connect(wet).connect(offline.destination);
    src.start(0);
    setStatus('Rendering (this may take a few seconds)...');
    const rendered = await offline.startRendering();
    setStatus('Rendering done.');
    return rendered;
  }

  function audioBufferToWav(buffer){
    const numChannels = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const bytesPerSample = 2;
    const blockAlign = numChannels * bytesPerSample;
    const dataLen = buffer.length * blockAlign;
    const bufferLen = 44 + dataLen;
    const arrayBuffer = new ArrayBuffer(bufferLen);
    const view = new DataView(arrayBuffer);
    function writeString(view, offset, str){
      for(let i=0;i<str.length;i++){
        view.setUint8(offset+i, str.charCodeAt(i));
      }
    }
    let offset = 0;
    writeString(view, offset, 'RIFF'); offset += 4;
    view.setUint32(offset, 36 + dataLen, true); offset += 4;
    writeString(view, offset, 'WAVE'); offset += 4;
    writeString(view, offset, 'fmt '); offset += 4;
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2;
    view.setUint16(offset, numChannels, true); offset += 2;
    view.setUint32(offset, sampleRate, true); offset += 4;
    view.setUint32(offset, sampleRate * blockAlign, true); offset += 4;
    view.setUint16(offset, blockAlign, true); offset += 2;
    view.setUint16(offset, bytesPerSample*8, true); offset += 2;
    writeString(view, offset, 'data'); offset += 4;
    view.setUint32(offset, dataLen, true); offset += 4;
    let pos = 44;
    const channelData = [];
    for(let ch=0; ch<numChannels; ch++) channelData.push(buffer.getChannelData(ch));
    for(let i=0;i<buffer.length;i++){
      for(let ch=0; ch<numChannels; ch++){
        let sample = Math.max(-1, Math.min(1, channelData[ch][i]));
        view.setInt16(pos, sample < 0 ? sample * 0x8000 : sample * 0x7fff, true);
        pos += 2;
      }
    }
    return new Blob([view], { type: 'audio/wav' });
  }

  async function preview(){
    if(!originalBuffer) { setStatus('Select an audio first'); return; }
    stopLive();
    try{
      const opts = { playbackRate: parseFloat(speedEl.value), reverbAmount: parseFloat(reverbEl.value), decay: parseFloat(decayEl.value) };
      const rendered = await renderBuffer(originalBuffer, opts);
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      const src = ac.createBufferSource();
      src.buffer = rendered;
      src.connect(ac.destination);
      src.start(0);
      liveSource = src;
      realtimeCtx = ac;
      setStatus('Preview playing...');
      src.onended = ()=>{ setStatus('Preview finished'); try{ ac.close(); }catch(e){} liveSource = null; };
    }catch(err){
      console.error(err);
      setStatus('Preview error: '+(err.message||err));
    }
  }

  async function renderAndDownload(){
    if(!originalBuffer) { setStatus('Select an audio first'); return; }
    stopLive();
    try{
      renderBtn.disabled = true;
      previewBtn.disabled = true;
      const opts = { playbackRate: parseFloat(speedEl.value), reverbAmount: parseFloat(reverbEl.value), decay: parseFloat(decayEl.value) };
      const rendered = await renderBuffer(originalBuffer, opts);
      const wavBlob = audioBufferToWav(rendered);
      cleanupLast();
      lastURL = URL.createObjectURL(wavBlob);
      player.src = lastURL; player.style.display = 'block';
      downloadA.href = lastURL; downloadA.download = `processed_${Date.now()}.wav`; downloadA.style.display = 'inline-block';
      setStatus('Ready — click Download or play below.');
    }catch(err){
      console.error(err);
      setStatus('Render error: '+(err.message||err));
    } finally {
      renderBtn.disabled = false;
      previewBtn.disabled = false;
    }
  }

  function stopLive(){
    try{
      if(liveSource){ liveSource.stop && liveSource.stop(); liveSource = null; }
      if(realtimeCtx){ realtimeCtx.close && realtimeCtx.close(); realtimeCtx = null; }
    }catch(e){}
  }

  function cleanupLast(){
    if(lastURL){ try{ URL.revokeObjectURL(lastURL); }catch(e){} lastURL = null; player.src = ''; player.style.display='none'; downloadA.style.display='none'; }
  }

  previewBtn.addEventListener('click', preview);
  renderBtn.addEventListener('click', renderAndDownload);
  stopBtn.addEventListener('click', ()=>{ stopLive(); setStatus('Stopped'); });
  window.addEventListener('beforeunload', ()=>{ cleanupLast(); });
})();
</script>
</body>
</html>
