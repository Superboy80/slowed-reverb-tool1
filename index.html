<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slowed + Reverb Tool with Bass</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Cool purple gradient background */
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            color: #333;
        }

        h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            backdrop-filter: blur(10px); /* Glassmorphism effect for modern look */
        }

        .btn {
            border-radius: 25px;
            font-weight: bold;
        }

        .progress {
            height: 25px;
            border-radius: 15px;
        }

        #preview {
            border-radius: 10px;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            .card-body {
                padding: 1rem;
            }
            input[type="range"] {
                width: 100%;
            }
        }

        /* Desktop Smoothness */
        @media (min-width: 769px) {
            .card {
                max-width: 600px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-8 col-sm-12">
                <h1 class="text-center mb-4">ðŸŽµ Slowed + Reverb + Bass Magic Tool</h1>
                <p class="text-center text-muted">Upload your song, tweak slowed speed, smooth reverb, and bass boost â€“ download the ultimate vibe!</p>
                
                <div class="card shadow-lg">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="audioFile" class="form-label">Upload Audio File (MP3/WAV, max 100MB)</label>
                            <input type="file" class="form-control" id="audioFile" accept="audio/*">
                        </div>
                        
                        <div class="mb-3">
                            <label for="slowSpeed" class="form-label">Slow Speed (0.5x to 1x)</label>
                            <input type="range" class="form-range" id="slowSpeed" min="0.5" max="1" step="0.1" value="0.8">
                            <span id="speedValue">0.8x</span>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reverbTime" class="form-label">Reverb Time (1-5s, Smooth Hall Effect)</label>
                            <input type="range" class="form-range" id="reverbTime" min="1" max="5" step="0.5" value="2">
                            <span id="reverbValue">2s</span>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bassBoost" class="form-label">Bass Boost (0-20dB, Deep Lows)</label>
                            <input type="range" class="form-range" id="bassBoost" min="0" max="20" step="2" value="10">
                            <span id="bassValue">10dB</span>
                        </div>
                        
                        <button class="btn btn-primary w-100 mb-3" id="processBtn" disabled>Apply Effects & Download</button>
                        
                        <div id="progress" class="progress mb-3" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;">Processing...</div>
                        </div>
                        
                        <audio id="preview" controls class="w-100 mb-3" style="display: none;"></audio>
                        
                        <a id="downloadLink" class="btn btn-success w-100" style="display: none;">Download Processed Audio</a>
                        
                        <div id="errorMsg" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const audioFileInput = document.getElementById('audioFile');
            const processBtn = document.getElementById('processBtn');
            const progress = document.getElementById('progress');
            const progressBar = progress.querySelector('.progress-bar');
            const preview = document.getElementById('preview');
            const downloadLink = document.getElementById('downloadLink');
            const errorMsg = document.getElementById('errorMsg');
            const slowSpeed = document.getElementById('slowSpeed');
            const reverbTime = document.getElementById('reverbTime');
            const bassBoost = document.getElementById('bassBoost');
            const speedValue = document.getElementById('speedValue');
            const reverbValue = document.getElementById('reverbValue');
            const bassValue = document.getElementById('bassValue');

            // Update sliders display
            slowSpeed.addEventListener('input', () => speedValue.textContent = slowSpeed.value + 'x');
            reverbTime.addEventListener('input', () => reverbValue.textContent = reverbTime.value + 's');
            bassBoost.addEventListener('input', () => bassValue.textContent = bassBoost.value + 'dB');

            // File upload
            audioFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.size > 100 * 1024 * 1024) {
                    showError('File too large! Max 100MB.');
                    return;
                }
                if (file) {
                    processBtn.disabled = false;
                    preview.src = URL.createObjectURL(file); // Preview original
                    preview.style.display = 'block';
                }
            });

            // Process button
            processBtn.addEventListener('click', async function() {
                const file = audioFileInput.files[0];
                if (!file) {
                    showError('Please upload a file first!');
                    return;
                }

                showProgress(0);
                try {
                    const audioBuffer = await loadAudio(file);
                    const processedBuffer = await applyEffects(audioBuffer, parseFloat(slowSpeed.value), parseFloat(reverbTime.value), parseFloat(bassBoost.value));
                    const processedBlob = bufferToWave(processedBuffer, audioBuffer.sampleRate);
                    const url = URL.createObjectURL(processedBlob);
                    
                    downloadLink.href = url;
                    downloadLink.download = `slowed-reverb-bass_${file.name}`;
                    downloadLink.style.display = 'block';
                    preview.src = url; // Preview processed
                    hideError();
                } catch (err) {
                    showError('Error processing audio: ' + err.message);
                }
                hideProgress();
            });

            // Helper: Load audio buffer
            async function loadAudio(file) {
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                showProgress(20);
                return await audioContext.decodeAudioData(arrayBuffer);
            }

            // Main effects: Slowed + Bass + Smooth Reverb
            async function applyEffects(buffer, speed, reverbTime, bassGain) {
                const sampleRate = buffer.sampleRate;
                
                // Step 1: Slowed effect (resample buffer)
                showProgress(30);
                const slowedLength = Math.floor(buffer.length / speed);
                const slowedBuffer = new OfflineAudioContext(buffer.numberOfChannels, slowedLength, sampleRate).createBuffer(buffer.numberOfChannels, slowedLength, sampleRate);
                for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                    const inputData = buffer.getChannelData(channel);
                    const outputData = slowedBuffer.getChannelData(channel);
                    for (let i = 0; i < slowedLength; i++) {
                        const originalIndex = Math.floor(i * speed);
                        outputData[i] = inputData[originalIndex] || 0;
                    }
                }

                // Step 2: Apply Bass Boost + Reverb in OfflineContext
                showProgress(50);
                const offlineContext = new OfflineAudioContext(buffer.numberOfChannels, slowedLength, sampleRate);
                const source = offlineContext.createBufferSource();
                source.buffer = slowedBuffer;

                // Bass Boost: Low-shelf filter at 150Hz
                const bassFilter = offlineContext.createBiquadFilter();
                bassFilter.type = 'lowshelf';
                bassFilter.frequency.value = 150;
                bassFilter.gain.value = bassGain;

                // Smooth Reverb: Better impulse response (exponential decay + echoes)
                const reverb = offlineContext.createConvolver();
                const reverbLength = Math.floor(sampleRate * reverbTime);
                const reverbBuffer = offlineContext.createBuffer(1, reverbLength, sampleRate);
                const reverbData = reverbBuffer.getChannelData(0);
                
                // Generate smooth impulse: Initial impulse + decaying echoes (hall-like)
                reverbData[0] = 1.0; // Direct sound
                let decay = 1.0;
                const echoDelays = [0.05, 0.1, 0.2, 0.3, 0.5]; // Delays in seconds for room reflections
                for (let echo of echoDelays) {
                    const delaySamples = Math.floor(echo * sampleRate);
                    if (delaySamples < reverbLength) {
                        const echoAmp = decay * 0.3; // Echo amplitude
                        reverbData[delaySamples] += echoAmp;
                        // Add a short decay tail after each echo
                        for (let j = 1; j < 100 && delaySamples + j < reverbLength; j++) {
                            reverbData[delaySamples + j] += echoAmp * Math.exp(-j / (sampleRate * 0.1)); // Exponential decay
                        }
                        decay *= 0.7; // Reduce for next echo
                    }
                }
                // Fill rest with smooth decay noise (low-pass like)
                for (let i = 1; i < reverbLength; i++) {
                    if (reverbData[i] === 0) {
                        reverbData[i] = (Math.random() * 2 - 1) * 0.01 * Math.pow(1 - i / reverbLength, 2); // Very subtle tail
                    }
                }
                reverb.buffer = reverbBuffer;

                // Overall gain to prevent clipping
                const gain = offlineContext.createGain();
                gain.gain.value = 0.7; // Adjust based on effects

                // Chain: Source -> Bass -> Reverb -> Gain -> Destination
                source.connect(bassFilter);
                bassFilter.connect(reverb);
                reverb.connect(gain);
                gain.connect(offlineContext.destination);

                source.start(0);
                showProgress(80);
                const renderedBuffer = await offlineContext.startRendering();
                showProgress(100);
                return renderedBuffer;
            }

            // Convert buffer to WAV Blob
            function bufferToWave(buffer, sampleRate) {
                const numChannels = buffer.numberOfChannels;
                const length = buffer.length * numChannels * 2 + 44;
                const arrayBuffer = new ArrayBuffer(length);
                const view = new DataView(arrayBuffer);
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + buffer.length * numChannels * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * 2, true);
                view.setUint16(32, numChannels * 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, buffer.length * numChannels * 2, true);

                let offset = 44;
                for (let i = 0; i < buffer.length; i++) {
                    for (let channel = 0; channel < numChannels; channel++) {
                        const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                        view.setInt16(offset, sample * 0x7FFF, true);
                        offset += 2;
                    }
                }
                return new Blob([arrayBuffer], { type: 'audio/wav' });
            }

            function showProgress(percent) {
                progress.style.display = 'block';
                progressBar.style.width = percent + '%';
                progressBar.textContent = 'Processing... ' + percent + '%';
            }

            function hideProgress() {
                progress.style.display = 'none';
            }

            function showError(msg) {
                errorMsg.textContent = msg;
                errorMsg.style.display = 'block';
                processBtn.disabled = true;
            }

            function hideError() {
                errorMsg.style.display = 'none';
            }
        });
    </script>
</body>
</html>
