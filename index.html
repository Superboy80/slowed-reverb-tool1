<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro LoFi Slowed + Reverb + Bass Tool</title>
<style>
  body { background:#121212; color:white; font-family:Arial; text-align:center; padding:20px; }
  .control { margin:15px; }
  input[type=range], select { width:300px; }
  button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
  #uploadStatus { margin:10px; font-size:14px; }
  canvas { display:block; margin:20px auto; background:#222; border-radius:5px; }
</style>
</head>
<body>
<h1>üé∂ Pro LoFi Slowed + Reverb + Bass Tool</h1>

<input type="file" id="fileInput" accept="audio/*"><br>
<div id="uploadStatus"></div>

<button id="playBtn">‚ñ∂ Play</button>
<button id="stopBtn">‚èπ Stop</button>
<button id="downloadBtn">üíæ Render & Download</button>

<div class="control">
  <label>Volume: <span id="volumeVal">1.0</span></label><br>
  <input type="range" id="volumeControl" min="0" max="2" step="0.01" value="1">
</div>

<div class="control">
  <label>Speed Preset:</label><br>
  <select id="speedPreset">
    <option value="0.5">You won't like this</option>
    <option value="0.7">Slower</option>
    <option value="0.85">Less slower</option>
    <option value="1">Normal speed</option>
  </select><br>
  <label>Speed Slider: <span id="speedVal">1.0</span>x</label><br>
  <input type="range" id="speedControl" min="0.5" max="1.5" value="1" step="0.01">
</div>

<div class="control">
  <label>Reverb Preset:</label><br>
  <select id="reverbPreset">
    <option value="0">None</option>
    <option value="0.2">A bit</option>
    <option value="0.4">Light</option>
    <option value="0.6">Recommend</option>
    <option value="0.8">Spacey</option>
  </select><br>
  <label>Reverb Slider: <span id="reverbVal">0.0</span></label><br>
  <input type="range" id="reverbControl" min="0" max="1" value="0" step="0.01">
</div>

<div class="control">
  <label>Bass Boost: <span id="bassVal">0.0</span></label><br>
  <input type="range" id="bassControl" min="0" max="20" value="0" step="1">
</div>

<canvas id="visualizer" width="800" height="150"></canvas>

<script>
let audioCtx, audioBuffer, source = null;
let convolver, bassFilter, wetGain, dryGain, masterGain, volumeGain;
let analyser, dataArray, animationId;

// Upload audio
document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const status = document.getElementById("uploadStatus");
  status.textContent = "‚è≥ Uploading / Decoding audio...";
  try {
    const arrayBuffer = await file.arrayBuffer();
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    status.textContent = "‚úÖ Audio loaded! Press Play.";
  } catch(err) {
    status.textContent = "‚ùå Error loading audio!";
    console.error(err);
  }
});

// Reverb impulse
function createReverbIR(ctx) {
  let length = ctx.sampleRate * 3;
  let impulse = ctx.createBuffer(2, length, ctx.sampleRate);
  for (let c = 0; c < 2; c++) {
    let channel = impulse.getChannelData(c);
    for (let i = 0; i < length; i++) {
      channel[i] = (Math.random() * 2 - 1) * (1 - i/length);
    }
  }
  return impulse;
}

// Visualizer
function startVisualizer() {
  const canvas = document.getElementById("visualizer");
  const ctx = canvas.getContext("2d");
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);

  source.connect(analyser);
  analyser.connect(audioCtx.destination);

  function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);
    ctx.fillStyle = "#222";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const barWidth = (canvas.width / bufferLength) * 2.5;
    let x = 0;
    for(let i = 0; i < bufferLength; i++){
      const barHeight = dataArray[i]/2;
      ctx.fillStyle = `rgb(${barHeight+100},50,200)`;
      ctx.fillRect(x,canvas.height-barHeight,barWidth,barHeight);
      x += barWidth + 1;
    }
  }
  draw();
}

// Play
document.getElementById("playBtn").addEventListener("click", () => {
  if (!audioBuffer) return alert("Upload audio first!");
  if (audioCtx.state === "suspended") audioCtx.resume();

  if (source) { try{ source.stop(); } catch(e){} source.disconnect(); cancelAnimationFrame(animationId); }

  source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;

  // Audio chain
  bassFilter = audioCtx.createBiquadFilter();
  bassFilter.type = "lowshelf";
  bassFilter.frequency.value = 200;
  bassFilter.gain.value = parseFloat(document.getElementById("bassControl").value);

  convolver = audioCtx.createConvolver();
  convolver.buffer = createReverbIR(audioCtx);

  wetGain = audioCtx.createGain();
  dryGain = audioCtx.createGain();
  masterGain = audioCtx.createGain();
  volumeGain = audioCtx.createGain();

  source.connect(bassFilter);
  bassFilter.connect(dryGain);
  bassFilter.connect(convolver);
  convolver.connect(wetGain);
  dryGain.connect(masterGain);
  wetGain.connect(masterGain);
  masterGain.connect(volumeGain);
  volumeGain.connect(audioCtx.destination);

  dryGain.gain.value = 1;
  wetGain.gain.value = parseFloat(document.getElementById("reverbControl").value);
  source.playbackRate.value = parseFloat(document.getElementById("speedControl").value);
  volumeGain.gain.value = parseFloat(document.getElementById("volumeControl").value);

  startVisualizer();
  source.start();
});

// Stop
document.getElementById("stopBtn").addEventListener("click", () => {
  if (source) { try{ source.stop(); } catch(e){} source.disconnect(); source=null; cancelAnimationFrame(animationId);
    const canvas = document.getElementById("visualizer"); const ctx = canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  }
});

// Sliders
document.getElementById("volumeControl").addEventListener("input", e => {
  if(volumeGain) volumeGain.gain.value = parseFloat(e.target.value);
  document.getElementById("volumeVal").textContent = e.target.value;
});

document.getElementById("speedControl").addEventListener("input", e => {
  if(source) source.playbackRate.value = parseFloat(e.target.value);
  document.getElementById("speedVal").textContent = e.target.value;
});

document.getElementById("reverbControl").addEventListener("input", e => {
  if(wetGain) wetGain.gain.value = parseFloat(e.target.value);
  document.getElementById("reverbVal").textContent = e.target.value;
});

document.getElementById("bassControl").addEventListener("input", e => {
  if(bassFilter) bassFilter.gain.value = parseFloat(e.target.value);
  document.getElementById("bassVal").textContent = e.target.value;
});

// Presets
document.getElementById("speedPreset").addEventListener("change", e => {
  document.getElementById("speedControl").value = e.target.value;
  document.getElementById("speedVal").textContent = e.target.value;
  if(source) source.playbackRate.value = parseFloat(e.target.value);
});

document.getElementById("reverbPreset").addEventListener("change", e => {
  document.getElementById("reverbControl").value = e.target.value;
  document.getElementById("reverbVal").textContent = e.target.value;
  if(wetGain) wetGain.gain.value = parseFloat(e.target.value);
});

// Render & Download (OfflineAudioContext)
document.getElementById("downloadBtn").addEventListener("click", async () => {
  if (!audioBuffer) return alert("Upload audio first!");
  const offlineCtx = new OfflineAudioContext(2, audioBuffer.length, audioBuffer.sampleRate);

  const src = offlineCtx.createBufferSource();
  src.buffer = audioBuffer;

  const bass = offlineCtx.createBiquadFilter();
  bass.type = "lowshelf";
  bass.frequency.value = 200;
  bass.gain.value = parseFloat(document.getElementById("bassControl").value);

  const conv = offlineCtx.createConvolver();
  conv.buffer = createReverbIR(offlineCtx);

  const wet = offlineCtx.createGain();
  const dry = offlineCtx.createGain();
  const master = offlineCtx.createGain();
  const volume = offlineCtx.createGain();

  src.connect(bass);
  bass.connect(dry);
  bass.connect(conv);
  conv.connect(wet);
  dry.connect(master);
  wet.connect(master);
  master.connect(volume);
  volume.connect(offlineCtx.destination);

  dry.gain.value = 1;
  wet.gain.value = parseFloat(document.getElementById("reverbControl").value);
  src.playbackRate.value = parseFloat(document.getElementById("speedControl").value);
  volume.gain.value = parseFloat(document.getElementById("volumeControl").value);

  src.start();
  const renderedBuffer = await offlineCtx.startRendering();
  const wavBlob = bufferToWave(renderedBuffer, renderedBuffer.length);
  const url = URL.createObjectURL(wavBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "slowed_reverb.wav";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

// Helper: buffer to WAV
function bufferToWave(abuffer, len) {
  let numOfChan = abuffer.numberOfChannels,
      length = len * numOfChan * 2 + 44,
      buffer = new ArrayBuffer(length),
      view = new DataView(buffer),
      channels = [], i, sample,
      offset = 0, pos = 0;

  setUint32(0x46464952); // "RIFF"
  setUint32(length - 8);
  setUint32(0
