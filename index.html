<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro LoFi Slowed + Reverb + Bass Tool</title>
<style>
  body { background:#121212; color:white; font-family:Arial; text-align:center; padding:20px; }
  .control { margin:15px; }
  input[type=range] { width:300px; }
  button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
  #loader { display:none; margin:10px; }
  #progressContainer { width:300px; margin:10px auto; }
</style>
</head>
<body>
<h1>üé∂ LoFi Slowed + Reverb + Bass Tool</h1>

<input type="file" id="fileInput" accept="audio/*"><br>
<div id="loader">Uploading & Loading...</div>

<button id="playBtn">‚ñ∂ Play</button>
<button id="stopBtn">‚èπ Stop</button>
<button id="restartBtn">üîÑ Restart</button>
<button id="downloadBtn">üíæ Render & Download</button>

<div class="control">
  <label>Speed: <span id="speedVal">1.0</span>x</label><br>
  <input type="range" id="speedControl" min="0.5" max="1.5" value="1" step="0.01">
</div>

<div class="control">
  <label>Reverb: <span id="reverbVal">0.0</span></label><br>
  <input type="range" id="reverbControl" min="0" max="1" value="0" step="0.01">
</div>

<div class="control">
  <label>Bass: <span id="bassVal">0</span></label><br>
  <input type="range" id="bassControl" min="0" max="20" value="0" step="1">
</div>

<div class="control">
  <label>Volume: <span id="volumeVal">100%</span></label><br>
  <input type="range" id="volumeControl" min="0" max="100" value="100" step="1">
</div>

<div id="progressContainer">
  <input type="range" id="progressSlider" min="0" max="100" value="0" step="0.01" style="width:100%;">
  <div><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
</div>

<canvas id="visualizer" width="600" height="100" style="background:#222; margin-top:20px;"></canvas>

<script>
let audioCtx, audioBuffer, source;
let convolver, bassFilter, wetGain, dryGain, masterGain, volumeGain;
let analyser, dataArray, animationId;
let startTime = 0, pausedAt = 0;

// Load audio
document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("loader").style.display = "block";

  if (source) stopAudio();
  pausedAt = 0;

  const arrayBuffer = await file.arrayBuffer();
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

  document.getElementById("loader").style.display = "none";
  document.getElementById("duration").textContent = formatTime(audioBuffer.duration);
  document.getElementById("progressSlider").value = 0;
  alert("‚úÖ Audio loaded! Now press Play.");
});

// Format seconds to mm:ss
function formatTime(seconds) {
  let min = Math.floor(seconds/60);
  let sec = Math.floor(seconds%60);
  if(sec<10) sec="0"+sec;
  return `${min}:${sec}`;
}

// Reverb impulse
function createReverbIR(ctx) {
  let length = ctx.sampleRate * 3;
  let impulse = ctx.createBuffer(2, length, ctx.sampleRate);
  for (let c=0;c<2;c++){
    let channel = impulse.getChannelData(c);
    for (let i=0;i<length;i++){
      channel[i] = (Math.random()*2-1)*(1-i/length);
    }
  }
  return impulse;
}

// Create Audio Graph
function createAudioGraph() {
  stopAudio();
  source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;

  bassFilter = audioCtx.createBiquadFilter();
  bassFilter.type = "lowshelf";
  bassFilter.frequency.value = 200;
  bassFilter.gain.value = parseFloat(document.getElementById("bassControl").value);

  convolver = audioCtx.createConvolver();
  convolver.buffer = createReverbIR(audioCtx);

  wetGain = audioCtx.createGain();
  dryGain = audioCtx.createGain();
  masterGain = audioCtx.createGain();
  volumeGain = audioCtx.createGain();

  // Connect graph
  source.connect(bassFilter);
  bassFilter.connect(dryGain);
  bassFilter.connect(convolver);
  convolver.connect(wetGain);
  dryGain.connect(masterGain);
  wetGain.connect(masterGain);
  masterGain.connect(volumeGain);
  volumeGain.connect(audioCtx.destination);

  // Analyser for visualization
  analyser = audioCtx.createAnalyser();
  masterGain.connect(analyser);
  analyser.fftSize = 256;
  dataArray = new Uint8Array(analyser.frequencyBinCount);

  // Set initial values
  source.playbackRate.value = parseFloat(document.getElementById("speedControl").value);
  wetGain.gain.value = parseFloat(document.getElementById("reverbControl").value);
  volumeGain.gain.value = parseFloat(document.getElementById("volumeControl").value)/100;
  source.onended = () => cancelAnimationFrame(animationId);
}

// Stop audio
function stopAudio() {
  if(source){
    try{ source.stop(0); } catch(e){}
    source.disconnect();
  }
  cancelAnimationFrame(animationId);
}

// Play button
document.getElementById("playBtn").addEventListener("click", async () => {
  if(!audioBuffer) return alert("Upload audio first!");
  if(audioCtx.state === "suspended") await audioCtx.resume();
  createAudioGraph();
  startTime = audioCtx.currentTime - pausedAt;
  source.start(0, pausedAt);
  visualize();
});

// Stop button
document.getElementById("stopBtn").addEventListener("click", ()=>{
  if(!source) return;
  pausedAt = audioCtx.currentTime - startTime;
  stopAudio();
});

// Restart button
document.getElementById("restartBtn").addEventListener("click", ()=>{
  pausedAt = 0;
  stopAudio();
  createAudioGraph();
  startTime = audioCtx.currentTime;
  source.start(0);
  visualize();
});

// Sliders
document.getElementById("speedControl").addEventListener("input", e => {
  if(source) source.playbackRate.value = parseFloat(e.target.value);
  document.getElementById("speedVal").textContent = e.target.value;
});

document.getElementById("reverbControl").addEventListener("input", e=>{
  if(wetGain) wetGain.gain.value = parseFloat(e.target.value);
  document.getElementById("reverbVal").textContent = e.target.value;
});

document.getElementById("bassControl").addEventListener("input", e=>{
  if(bassFilter) bassFilter.gain.value = parseFloat(e.target.value);
  document.getElementById("bassVal").textContent = e.target.value;
});

document.getElementById("volumeControl").addEventListener("input", e=>{
  if(volumeGain) volumeGain.gain.value = parseFloat(e.target.value)/100;
  document.getElementById("volumeVal").textContent = e.target.value + "%";
});

// Progress slider
const progressSlider = document.getElementById("progressSlider");
progressSlider.addEventListener("input", e=>{
  if(!audioBuffer) return;
  let seekTime = (audioBuffer.duration * e.target.value)/100;
  pausedAt = seekTime;
  if(source){
    stopAudio();
    createAudioGraph();
    startTime = audioCtx.currentTime - pausedAt;
    source.start(0, pausedAt);
    visualize();
  }
});

// Visualization
const canvas = document.getElementById("visualizer");
const ctx = canvas.getContext("2d");
function visualize(){
  animationId = requestAnimationFrame(visualize);
  analyser.getByteFrequencyData(dataArray);
